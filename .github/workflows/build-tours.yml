name: Build Tours Data

# This workflow parses tour shortcodes from markdown files in the backup repo
# and generates a consolidated tours.json file that is pushed to the plugin repo.

on:
  # Run daily at 4 AM UTC
  schedule:
    - cron: '0 4 * * *'

  # Allow manual triggering
  workflow_dispatch:

  # Optionally run on push to main (uncomment if desired)
  # push:
  #   branches:
  #     - main

jobs:
  build-tours:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout backup repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/scripts
          npm install

      - name: Parse tour shortcodes
        id: parse
        run: |
          # Run the parser script
          node .github/scripts/parse-tours.js

          # Check if tours.json was created
          if [ ! -f tours.json ]; then
            echo "ERROR: tours.json was not created"
            exit 1
          fi

          # Count tours found
          TOUR_COUNT=$(jq '.tours | length' tours.json)
          echo "Found $TOUR_COUNT tours"
          echo "tour_count=$TOUR_COUNT" >> $GITHUB_OUTPUT

      - name: Checkout plugin repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PLUGIN_REPO || 'flschr/mbplugin-fischr-tours' }}
          path: plugin-repo
          ssh-key: ${{ secrets.PLUGIN_DEPLOY_KEY }}
          # Alternative: Use PAT if deploy key is not set
          # token: ${{ secrets.PLUGIN_PAT }}

      - name: Generate static map images
        id: generate_maps
        run: |
          # Set plugin repo directory for the script
          export PLUGIN_REPO_DIR="./plugin-repo"

          # Create maps directory if it doesn't exist
          mkdir -p plugin-repo/static/maps

          # Run map generation script
          node .github/scripts/generate-map-images.js

          # Count generated images
          MAP_COUNT=$(ls -1 plugin-repo/static/maps/*.png 2>/dev/null | wc -l || echo 0)
          echo "Generated $MAP_COUNT map images"
          echo "map_count=$MAP_COUNT" >> $GITHUB_OUTPUT

      - name: Update tours data in plugin repo
        id: update
        run: |
          # Copy tours.json to plugin repo
          cp tours.json plugin-repo/data/tours.json

          cd plugin-repo

          # Check if there are changes
          git add -N . # Include new files in diff check
          if git diff --quiet; then
            echo "No changes to tours.json or maps"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in tours.json or maps"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push to plugin repo
        if: steps.update.outputs.has_changes == 'true'
        run: |
          cd plugin-repo

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/tours.json static/maps/
          git commit -m "Update tours data and static map images

          - Tours: ${{ steps.parse.outputs.tour_count }}
          - Maps: ${{ steps.generate_maps.outputs.map_count }}

          Auto-generated from backup repo by GitHub Actions
          Triggered: ${{ github.event_name }}
          Run: ${{ github.run_number }}"

          git push

      - name: Summary
        run: |
          echo "### Tours Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tours found:** ${{ steps.parse.outputs.tour_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Maps generated:** ${{ steps.generate_maps.outputs.map_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes detected:** ${{ steps.update.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.update.outputs.has_changes }}" = "true" ]; then
            echo "- **Status:** ✅ Tours data and maps updated in plugin repo" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** ℹ️ No changes, skipped push" >> $GITHUB_STEP_SUMMARY
          fi
