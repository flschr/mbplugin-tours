{{- /*
  Tour Shortcode - Renders a tour info box with optional static map image

  Required params: id, title, date, type, distance_km, elevation_m, gpx
  Optional params: region, duration_h, max_height, bergfex_url, cover_image, peaks

  XSS Safety: All user parameters are properly escaped via htmlEscape or used only as attributes
*/ -}}

{{- $id := .Get "id" -}}
{{- $title := .Get "title" -}}
{{- $type := .Get "type" -}}
{{- $region := .Get "region" -}}
{{- $distanceKm := .Get "distance_km" -}}
{{- $elevationM := .Get "elevation_m" -}}
{{- $durationH := .Get "duration_h" -}}
{{- $maxHeight := .Get "max_height" -}}
{{- $gpx := .Get "gpx" -}}
{{- $coverImage := .Get "cover_image" -}}
{{- $bergfexUrl := .Get "bergfex_url" -}}
{{- $peaksRaw := .Get "peaks" -}}

{{- /* Load tour styles only once per page */ -}}
{{- if not (.Page.Scratch.Get "tour-assets-loaded") -}}
  {{- .Page.Scratch.Set "tour-assets-loaded" true -}}
  <link rel="stylesheet" href="{{ "tours/styles.css" | relURL }}" />
{{- end -}}

{{- /* Load map dependencies (Leaflet + fallback script) once */ -}}
{{- if not (.Page.Scratch.Get "tour-map-assets-loaded") -}}
  {{- .Page.Scratch.Set "tour-map-assets-loaded" true -}}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-gpx@1.7.0/gpx.min.js" integrity="sha512-/yPV78iMZW2vseexUfxggYuVB4fzq40fsDVwz3tWOl9cb8MvCnmMCOjze1omsEj+APUuwZgnpcv5NR5q363JBA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="{{ "tours/tour-maps.js" | relURL }}" defer></script>
{{- end -}}

{{- $typeLabel := $type -}}
{{- if eq $type "hike" -}}
  {{- $typeLabel = "Hike" -}}
{{- else if eq $type "mtb" -}}
  {{- $typeLabel = "MTB" -}}
{{- else if eq $type "gravel" -}}
  {{- $typeLabel = "Gravel" -}}
{{- else if eq $type "run" -}}
  {{- $typeLabel = "Run" -}}
{{- end -}}

{{- /* Map rendering: Use dynamic Leaflet map if GPX is provided */ -}}
{{- $shouldRenderMap := and $gpx (ne $gpx "") -}}
{{- $hasMeta := or $region $type -}}
{{- $hasMapActions := or $gpx $bergfexUrl -}}

{{- $peaksRawTrimmed := "" -}}
{{- if $peaksRaw -}}
  {{- $peaksRawTrimmed = trim $peaksRaw " \n\t;" -}}
{{- end -}}
{{- $hasPeaks := and $peaksRaw (ne $peaksRawTrimmed "") -}}

{{- /* Build structured peak data once for both chips and map markers */ -}}
{{- $peaksList := slice -}}
{{- if $hasPeaks -}}
  {{- range $value := split $peaksRaw ";" -}}
    {{- $peak := trim $value " \n\t" -}}
    {{- if $peak -}}
      {{- $peakLabel := $peak -}}
      {{- $lat := "" -}}
      {{- $lng := "" -}}

      {{- if in $peak "|" -}}
        {{- $parts := split $peak "|" -}}
        {{- $peakLabel = trim (index $parts 0) " \n\t" -}}
        {{- if ge (len $parts) 3 -}}
          {{- $lat = trim (index $parts 1) " \n\t" -}}
          {{- $lng = trim (index $parts 2) " \n\t" -}}
        {{- end -}}
      {{- else if in $peak ":" -}}
        {{- $parts := split $peak ":" -}}
        {{- $name := trim (index $parts 0) " \n\t" -}}
        {{- $coordsPart := "" -}}
        {{- if ge (len $parts) 2 -}}
          {{- $coordsPart = trim (index $parts 1) " \n\t" -}}
        {{- end -}}
        {{- $metaParts := slice -}}
        {{- if ge (len $parts) 3 -}}
          {{- range $idx, $val := $parts -}}
            {{- if ge $idx 2 -}}
              {{- $metaParts = $metaParts | append (trim $val " \n\t") -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
        {{- $meta := delimit $metaParts ":" -}}
        {{- if $meta -}}
          {{- $peakLabel = trim (printf "%s %s" $name $meta) " \n\t" -}}
        {{- else -}}
          {{- $peakLabel = $name -}}
        {{- end -}}
        {{- $coordPieces := split $coordsPart "," -}}
        {{- if ge (len $coordPieces) 2 -}}
          {{- $lat = trim (index $coordPieces 0) " \n\t" -}}
          {{- $lng = trim (index $coordPieces 1) " \n\t" -}}
        {{- end -}}
      {{- else -}}
        {{- $peakLabel = trim $peak " \n\t" -}}
      {{- end -}}

      {{- $peakDict := dict "label" $peakLabel -}}
      {{- $hasCoords := and $lat (ne $lat "") $lng (ne $lng "") -}}
      {{- if $hasCoords -}}
        {{- $peakDict = merge $peakDict (dict "lat" $lat "lng" $lng) -}}
      {{- end -}}
      {{- $peaksList = $peaksList | append $peakDict -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $peaksWithCoords := where $peaksList "lat" "ne" nil -}}
{{- $peaksDataJSON := "" -}}
{{- if gt (len $peaksWithCoords) 0 -}}
  {{- $peaksDataJSON = $peaksList | jsonify -}}
{{- end -}}

<div class="tour-box" id="tour-{{ $id | htmlEscape }}" data-tour-id="{{ $id | htmlEscape }}">
  <div class="tour-card-hero">
    {{- if $shouldRenderMap -}}
    <div class="tour-card-map tour-card-map--full">
      <div class="tour-map-dynamic"
           data-tour-map-canvas
           data-gpx="{{ $gpx | htmlEscape }}"
           {{- if $peaksDataJSON }} data-peaks='{{ $peaksDataJSON | htmlEscape }}'{{ end }}></div>
    </div>
    {{- else -}}
    <div class="map-error map-error--full">Keine Karte verfügbar</div>
    {{- end -}}

    <div class="tour-card-header">
      <div class="tour-card-heading">
        {{- if $hasMeta -}}
        <p class="tour-card-meta">
          {{- if $typeLabel -}}
          <span>{{ $typeLabel | htmlEscape }}</span>
          {{- end -}}
          {{- if and $typeLabel $region -}}
          <span class="tour-card-meta-separator">,</span>
          {{- end -}}
          {{- if $region -}}
          <span>{{ $region | htmlEscape }}</span>
          {{- end -}}
        </p>
        {{- end -}}
        <h3 class="tour-card-title">{{ $title | htmlEscape }}</h3>
      </div>
    </div>
  </div>

  {{- if $coverImage -}}
  <div class="tour-card-visuals tour-card-visuals--compact">
    <figure class="tour-cover">
      <img src="{{ $coverImage | htmlEscape }}" alt="{{ $title | htmlEscape }}" loading="lazy" />
      <figcaption>Tourfoto</figcaption>
    </figure>
  </div>
  {{- end -}}

  <div class="tour-card-body">
    <div class="tour-stats-grid">
      {{- if $distanceKm -}}
      <div class="tour-stat-card">
        <div class="stat-text">
          <p class="stat-label">Distanz</p>
          <p class="stat-value">
            <span class="stat-number">{{ $distanceKm | htmlEscape }}</span>
            <span class="stat-unit">km</span>
          </p>
        </div>
      </div>
      {{- end -}}

      {{- if $elevationM -}}
      <div class="tour-stat-card">
        <div class="stat-text">
          <p class="stat-label">Aufstieg</p>
          <p class="stat-value">
            <span class="stat-number">{{ $elevationM | htmlEscape }}</span>
            <span class="stat-unit">m</span>
          </p>
        </div>
      </div>
      {{- end -}}

      {{- if $maxHeight -}}
      <div class="tour-stat-card">
        <div class="stat-text">
          <p class="stat-label">Max. Höhe</p>
          <p class="stat-value">
            <span class="stat-number">{{ $maxHeight | htmlEscape }}</span>
            <span class="stat-unit">m</span>
          </p>
        </div>
      </div>
      {{- end -}}

      {{- if $durationH -}}
      <div class="tour-stat-card">
        <div class="stat-text">
          <p class="stat-label">Dauer</p>
          <p class="stat-value">
            <span class="stat-number">{{ $durationH | htmlEscape }}</span>
            <span class="stat-unit">Std</span>
          </p>
        </div>
      </div>
      {{- end -}}
    </div>

    {{- if $hasPeaks -}}
    <div class="tour-peaks">
      <p class="tour-section-label">Gipfelbuch</p>
      <div class="tour-peaks-chips">
        {{- $peakMapIndex := 0 -}}
        {{- range $index, $peak := $peaksList -}}
          {{- $hasCoords := and (isset $peak "lat") (isset $peak "lng") $peak.lat $peak.lng (ne $peak.lat "") (ne $peak.lng "") -}}
          {{- if $hasCoords -}}
          <button type="button"
                  class="tour-peak-chip tour-peak-chip--action"
                  data-peak-index="{{ $peakMapIndex }}"
                  data-peak-lat="{{ $peak.lat | htmlEscape }}"
                  data-peak-lng="{{ $peak.lng | htmlEscape }}"
                  title="{{ printf "Gipfel %s auf der Karte zeigen" $peak.label | htmlEscape }}">
            <span class="tour-peak-chip-number">{{ add $index 1 }}</span>
            <span class="tour-peak-chip-label">{{ $peak.label | htmlEscape }}</span>
          </button>
          {{- $peakMapIndex = add $peakMapIndex 1 -}}
          {{- else -}}
          <span class="tour-peak-chip tour-peak-chip--static">
            <span class="tour-peak-chip-number">{{ add $index 1 }}</span>
            <span class="tour-peak-chip-label">{{ $peak.label | htmlEscape }}</span>
          </span>
          {{- end -}}
        {{- end -}}
      </div>
    </div>
    {{- end -}}

    {{- if $hasMapActions -}}
    <div class="tour-card-footer">
      <div class="tour-map-actions">
        {{- if $gpx -}}
        <a href="{{ $gpx | htmlEscape }}" download class="map-action-btn" title="GPX herunterladen">
          <span>GPX</span>
        </a>
        {{- end -}}

        {{- if $bergfexUrl -}}
        <a href="{{ $bergfexUrl | htmlEscape }}" target="_blank" rel="noopener noreferrer" class="map-action-btn" title="Auf Bergfex ansehen">
          <span>Bergfex</span>
        </a>
        {{- end -}}
      </div>
    </div>
    {{- end -}}

  </div>
</div>
