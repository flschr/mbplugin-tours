{{- /*
  Tour Shortcode - Renders a tour info box with optional static map image

  Required params: id, title, date, type, distance_km, elevation_m, gpx
  Optional params: region, duration_h, max_height, bergfex_url, cover_image, peaks

  XSS Safety: All user parameters are properly escaped via htmlEscape or used only as attributes
*/ -}}

{{- $id := .Get "id" -}}
{{- $title := .Get "title" -}}
{{- $date := .Get "date" -}}
{{- $type := .Get "type" -}}
{{- $region := .Get "region" -}}
{{- $distanceKm := .Get "distance_km" -}}
{{- $elevationM := .Get "elevation_m" -}}
{{- $durationH := .Get "duration_h" -}}
{{- $maxHeight := .Get "max_height" -}}
{{- $gpx := .Get "gpx" -}}
{{- $coverImage := .Get "cover_image" -}}
{{- $bergfexUrl := .Get "bergfex_url" -}}
{{- $peaksRaw := .Get "peaks" -}}

{{- /* Load tour styles only once per page */ -}}
{{- if not (.Page.Scratch.Get "tour-assets-loaded") -}}
  {{- .Page.Scratch.Set "tour-assets-loaded" true -}}
  <link rel="stylesheet" href="{{ "tours/styles.css" | relURL }}" />
{{- end -}}

{{- /* Load map dependencies (Leaflet + fallback script) once */ -}}
{{- if not (.Page.Scratch.Get "tour-map-assets-loaded") -}}
  {{- .Page.Scratch.Set "tour-map-assets-loaded" true -}}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-sA+4wI1z88LHg0CQ7YvyZr++VXjjhMVekjwXeRtigQ2nXrjXFdV7c40YQUhCEV4nWw2BNbWhv1M8M9O4n9g3g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-bxkBkayh3CC0MsGFbFDax3XIozzBn8wtPFQyu1HFDaRao7IhiHBpjz2uVH54camzatoorktr1cGIs3bN5wQ1xQ==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-gpx@1.7.0/gpx.min.js" integrity="sha512-ayM8YGtS+wGGyRyvE4s46HoPazTA/gkGEXUXMaLLq5yRvCNrI6VsgGAaHo9dZYkTfGZNVVRFlE0YyqS/fWznGQ==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
  <script src="{{ "tours/tour-maps.js" | relURL }}" defer></script>
{{- end -}}

{{- $formattedDate := "" -}}
{{- if $date -}}
  {{- $parsedDate := time.AsTime $date -}}
  {{- $formattedDate = $parsedDate.Format "02.01.2006" -}}
{{- end -}}

{{- $typeLabel := $type -}}
{{- if eq $type "hike" -}}
  {{- $typeLabel = "Hike" -}}
{{- else if eq $type "mtb" -}}
  {{- $typeLabel = "MTB" -}}
{{- else if eq $type "gravel" -}}
  {{- $typeLabel = "Gravel" -}}
{{- else if eq $type "run" -}}
  {{- $typeLabel = "Run" -}}
{{- end -}}

{{- /* Map rendering: Use dynamic Leaflet map if GPX is provided */ -}}
{{- $shouldRenderMap := and $gpx (ne $gpx "") -}}

{{- $peaksRawTrimmed := "" -}}
{{- if $peaksRaw -}}
  {{- $peaksRawTrimmed = trim $peaksRaw " \n\t;" -}}
{{- end -}}
{{- $hasPeaks := and $peaksRaw (ne $peaksRawTrimmed "") -}}

<div class="tour-box" id="tour-{{ $id | htmlEscape }}" data-tour-id="{{ $id | htmlEscape }}">
  <div class="tour-card-header">
    <div class="tour-card-heading">
      <h3 class="tour-card-title">{{ $title | htmlEscape }}</h3>
      {{- $hasMeta := or $formattedDate (or $region $type) -}}
      {{- if $hasMeta -}}
      <div class="tour-card-region">
        {{- if $formattedDate -}}
        <span class="tour-region-meta">
          <svg class="tour-meta-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M7.5 3.75V2.25M16.5 3.75V2.25M6 7.5h12M5.25 6h13.5a1.5 1.5 0 0 1 1.5 1.5V19.5a1.5 1.5 0 0 1-1.5 1.5H5.25A1.5 1.5 0 0 1 3.75 19.5V7.5A1.5 1.5 0 0 1 5.25 6zM9 11.25h6v6h-6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span>{{ $formattedDate }}</span>
        </span>
        {{- end -}}

        {{- if $region -}}
        <span class="tour-region-meta">
          <svg class="tour-meta-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M12 2.25c-3.18 0-5.75 2.52-5.75 5.63 0 4.34 5.75 11.12 5.75 11.12s5.75-6.78 5.75-11.12c0-3.11-2.57-5.63-5.75-5.63zm0 8.38a2.75 2.75 0 1 1 0-5.5 2.75 2.75 0 0 1 0 5.5z" fill="currentColor" />
          </svg>
          <span>{{ $region | htmlEscape }}</span>
        </span>
        {{- end -}}

        {{- if $type -}}
        <span class="tour-region-meta">
          <svg class="tour-meta-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M6 3v18M6 4.5h9l-2 4 2 4H6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span>{{ $typeLabel | htmlEscape }}</span>
        </span>
        {{- end -}}
      </div>
      {{- end -}}
    </div>
  </div>

  {{- if $shouldRenderMap -}}
  <div class="tour-card-map tour-card-map--full">
    <div class="tour-map-dynamic" data-tour-map-canvas data-gpx="{{ $gpx | htmlEscape }}"></div>

    {{- if or $gpx $bergfexUrl -}}
    <div class="tour-map-actions">
      {{- if $gpx -}}
      <a href="{{ $gpx | htmlEscape }}" download class="map-action-btn" title="GPX herunterladen">
        <span>GPX</span>
      </a>
      {{- end -}}

      {{- if $bergfexUrl -}}
      <a href="{{ $bergfexUrl | htmlEscape }}" target="_blank" rel="noopener noreferrer" class="map-action-btn" title="Auf Bergfex ansehen">
        <span>Bergfex</span>
      </a>
      {{- end -}}
    </div>
    {{- end -}}
  </div>
  {{- else -}}
  <div class="map-error map-error--full">Keine Karte verfügbar</div>
  {{- end -}}

  {{- if $coverImage -}}
  <div class="tour-card-visuals tour-card-visuals--compact">
    <figure class="tour-cover">
      <img src="{{ $coverImage | htmlEscape }}" alt="{{ $title | htmlEscape }}" loading="lazy" />
      <figcaption>Tourfoto</figcaption>
    </figure>
  </div>
  {{- end -}}

  <div class="tour-card-body">
    <div class="tour-stats-grid">
      {{- if $distanceKm -}}
      <div class="tour-stat-card">
        <div class="stat-text">
          <p class="stat-label">Distanz</p>
          <p class="stat-value">
            <span class="stat-number">{{ $distanceKm | htmlEscape }}</span>
            <span class="stat-unit">km</span>
          </p>
        </div>
      </div>
      {{- end -}}

      {{- if $elevationM -}}
      <div class="tour-stat-card">
        <div class="stat-text">
          <p class="stat-label">Aufstieg</p>
          <p class="stat-value">
            <span class="stat-number">{{ $elevationM | htmlEscape }}</span>
            <span class="stat-unit">m</span>
          </p>
        </div>
      </div>
      {{- end -}}

      {{- if $maxHeight -}}
      <div class="tour-stat-card">
        <div class="stat-text">
          <p class="stat-label">Max. Höhe</p>
          <p class="stat-value">
            <span class="stat-number">{{ $maxHeight | htmlEscape }}</span>
            <span class="stat-unit">m</span>
          </p>
        </div>
      </div>
      {{- end -}}

      {{- if $durationH -}}
      <div class="tour-stat-card">
        <div class="stat-text">
          <p class="stat-label">Dauer</p>
          <p class="stat-value">
            <span class="stat-number">{{ $durationH | htmlEscape }}</span>
            <span class="stat-unit">Std</span>
          </p>
        </div>
      </div>
      {{- end -}}
    </div>

    {{- if $hasPeaks -}}
    {{- $peakIndex := 0 -}}
    <div class="tour-peaks">
      <p class="tour-section-label">Bestiegene Gipfel</p>
      <div class="tour-peaks-chips">
        {{- range $value := split $peaksRaw ";" -}}
          {{- $peak := trim $value " \n\t" -}}
          {{- if $peak -}}
            {{- $peakIndex = add $peakIndex 1 -}}
            <span class="tour-peak-chip">
              <span class="tour-peak-chip-number">{{ $peakIndex }}</span>
              <span class="tour-peak-chip-label">{{ $peak | htmlEscape }}</span>
            </span>
          {{- end -}}
        {{- end -}}
      </div>
    </div>
    {{- end -}}

  </div>
</div>
