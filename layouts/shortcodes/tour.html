{{- /*
  Tour Shortcode - Renders a tour info box with optional Leaflet map

  Required params: id, title, date, type, distance_km, elevation_m, gpx
  Optional params: region, duration_h, max_height, bergfex_url, cover_image, peaks

  XSS Safety: All user parameters are properly escaped via htmlEscape or used only as attributes
*/ -}}

{{- $id := .Get "id" -}}
{{- $title := .Get "title" -}}
{{- $date := .Get "date" -}}
{{- $type := .Get "type" -}}
{{- $region := .Get "region" -}}
{{- $distanceKm := .Get "distance_km" -}}
{{- $elevationM := .Get "elevation_m" -}}
{{- $durationH := .Get "duration_h" -}}
{{- $maxHeight := .Get "max_height" -}}
{{- $gpx := .Get "gpx" -}}
{{- $coverImage := .Get "cover_image" -}}
{{- $bergfexUrl := .Get "bergfex_url" -}}
{{- $peaks := .Get "peaks" -}}

{{- /* Load tour styles only once per page */ -}}
{{- if not (.Page.Scratch.Get "tour-assets-loaded") -}}
  {{- .Page.Scratch.Set "tour-assets-loaded" true -}}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{{ "tours/styles.css" | relURL }}" />
{{- end -}}

<div class="tour-box" id="tour-{{ $id | htmlEscape }}" data-tour-id="{{ $id | htmlEscape }}">
  <div class="tour-ticket-headline">
    <div class="ticket-meta">
      {{- if $date -}}
      <div class="ticket-chip ticket-chip-date">
        <i class="fa-solid fa-calendar-days"></i>
        <span>
          {{- $parsedDate := time.AsTime $date -}}
          {{- $parsedDate.Format "02.01.2006" -}}
        </span>
      </div>
      {{- end -}}

      {{- if $type -}}
      {{- $typeClass := printf "ticket-chip-type-%s" (urlize $type) -}}
      <div class="ticket-chip ticket-chip-type {{ $typeClass }}">
        {{- if eq $type "hike" -}}<i class="fa-solid fa-person-hiking"></i><span>Hike</span>
        {{- else if eq $type "mtb" -}}<i class="fa-solid fa-person-biking"></i><span>MTB</span>
        {{- else if eq $type "gravel" -}}<i class="fa-solid fa-bicycle"></i><span>Gravel</span>
        {{- else if eq $type "run" -}}<i class="fa-solid fa-person-running"></i><span>Run</span>
        {{- else -}}<i class="fa-solid fa-mountain"></i><span>{{ $type | htmlEscape }}</span>
        {{- end -}}
      </div>
      {{- end -}}
    </div>

    <h3 class="tour-title">{{ $title | htmlEscape }}</h3>

    {{- if $region -}}
    <div class="ticket-region">Region: <span>{{ $region | htmlEscape }}</span></div>
    {{- end -}}
  </div>

  <div class="tour-ticket-grid">
    <div class="tour-column tour-column-details">
      {{- if $coverImage -}}
      <figure class="tour-cover">
        <img src="{{ $coverImage | htmlEscape }}" alt="{{ $title | htmlEscape }}" loading="lazy" />
        <figcaption>Tourfoto</figcaption>
      </figure>
      {{- end -}}

      <div class="tour-essentials">
        <div class="tour-section-label">Kenndaten</div>
        <div class="tour-stats">
          {{- if $distanceKm -}}
          <div class="tour-stat">
            <div class="stat-label">Distanz</div>
            <div class="stat-value">{{ $distanceKm | htmlEscape }}</div>
            <div class="stat-unit">km</div>
          </div>
          {{- end -}}

          {{- if $elevationM -}}
          <div class="tour-stat">
            <div class="stat-label">Aufstieg</div>
            <div class="stat-value">{{ $elevationM | htmlEscape }}</div>
            <div class="stat-unit">m</div>
          </div>
          {{- end -}}

          {{- if $maxHeight -}}
          <div class="tour-stat">
            <div class="stat-label">Max. Höhe</div>
            <div class="stat-value">{{ $maxHeight | htmlEscape }}</div>
            <div class="stat-unit">m</div>
          </div>
          {{- end -}}

          {{- if $durationH -}}
          <div class="tour-stat">
            <div class="stat-label">Dauer</div>
            <div class="stat-value">{{ $durationH | htmlEscape }}</div>
            <div class="stat-unit">h</div>
          </div>
          {{- end -}}
        </div>
      </div>

      {{- if $peaks -}}
      <div class="tour-peaks">
        <div class="tour-section-label">Gipfelprotokoll</div>
        <ol class="peaks-ledger">
          {{- range split $peaks ";" -}}
            {{- $peak := trim . " " -}}
            {{- if $peak -}}
            <li class="peak-row">
              <span class="peak-name">{{ $peak | htmlEscape }}</span>
            </li>
            {{- end -}}
          {{- end -}}
        </ol>
      </div>
      {{- end -}}
    </div>

    {{- $mapImage := .Get "map_image" -}}
    {{- if not $mapImage -}}
      {{- $mapImage = printf "/maps/%s.png" $id -}}
    {{- end -}}

    <div class="tour-column tour-column-map">
      <div class="tour-section-label">Tour</div>
      {{- if $mapImage -}}
      <div class="tour-map-frame">
        <img src="{{ $mapImage | htmlEscape }}"
             alt="Map of {{ $title | htmlEscape }}"
             class="tour-map-static"
             loading="lazy" />

        {{- if or $gpx $bergfexUrl -}}
        <div class="tour-map-actions">
          {{- if $gpx -}}
          <a href="{{ $gpx | htmlEscape }}" download class="map-action-btn" title="GPX herunterladen">
            <span>GPX</span>
            <i class="fa-solid fa-download"></i>
          </a>
          {{- end -}}

          {{- if $bergfexUrl -}}
          <a href="{{ $bergfexUrl | htmlEscape }}" target="_blank" rel="noopener noreferrer" class="map-action-btn" title="Auf Bergfex ansehen">
            <span>Bergfex</span>
            <i class="fa-solid fa-arrow-up-right-from-square"></i>
          </a>
          {{- end -}}
        </div>
        {{- end -}}
      </div>
      {{- else -}}
      <div class="map-error">Keine Karte verfügbar</div>
      {{- end -}}
    </div>
  </div>
</div>
