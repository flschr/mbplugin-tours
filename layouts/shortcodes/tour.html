{{- /*
  Tour Shortcode - Renders a tour info box with optional Leaflet map

  Required params: id, title, date, type, distance_km, elevation_m, gpx
  Optional params: region, duration_h, max_height, bergfex_url, cover_image, peaks

  XSS Safety: All user parameters are properly escaped via htmlEscape or used only as attributes
*/ -}}

{{- $id := .Get "id" -}}
{{- $title := .Get "title" -}}
{{- $date := .Get "date" -}}
{{- $type := .Get "type" -}}
{{- $region := .Get "region" -}}
{{- $distanceKm := .Get "distance_km" -}}
{{- $elevationM := .Get "elevation_m" -}}
{{- $durationH := .Get "duration_h" -}}
{{- $maxHeight := .Get "max_height" -}}
{{- $gpx := .Get "gpx" -}}
{{- $coverImage := .Get "cover_image" -}}
{{- $bergfexUrl := .Get "bergfex_url" -}}
{{- $peaks := .Get "peaks" -}}

{{- /* Load tour styles only once per page */ -}}
{{- if not (.Page.Scratch.Get "tour-assets-loaded") -}}
  {{- .Page.Scratch.Set "tour-assets-loaded" true -}}
  <link rel="stylesheet" href="{{ "tours/styles.css" | relURL }}" />
{{- end -}}

<div class="tour-box" id="tour-{{ $id | htmlEscape }}" data-tour-id="{{ $id | htmlEscape }}">
  <h3 class="tour-title">{{ $title | htmlEscape }}</h3>

  {{- if $coverImage -}}
  <div class="tour-cover">
    <img src="{{ $coverImage | htmlEscape }}" alt="{{ $title | htmlEscape }}" loading="lazy" />
  </div>
  {{- end -}}

  <div class="tour-main">
    {{- /* Left column: Info tiles and peaks */ -}}
    <div class="tour-info-section">
      {{- /* Type and Region badges */ -}}
      <div class="tour-meta-badges">
        {{- if $type -}}
        <div class="badge">
          {{- if eq $type "hike" -}}<span class="badge-icon">ğŸ¥¾</span><span>Hike</span>
          {{- else if eq $type "mtb" -}}<span class="badge-icon">ğŸšµ</span><span>MTB</span>
          {{- else if eq $type "gravel" -}}<span class="badge-icon">ğŸš´</span><span>Gravel</span>
          {{- else if eq $type "run" -}}<span class="badge-icon">ğŸƒ</span><span>Run</span>
          {{- else -}}<span class="badge-icon">â›°ï¸</span><span>{{ $type | htmlEscape }}</span>
          {{- end -}}
        </div>
        {{- end -}}

        {{- if $region -}}
        <div class="badge">
          <span class="badge-icon">ğŸ“</span>
          <span>{{ $region | htmlEscape }}</span>
        </div>
        {{- end -}}

        {{- if $date -}}
        <div class="badge">
          <span class="badge-icon">ğŸ“…</span>
          <span>{{ $date | htmlEscape }}</span>
        </div>
        {{- end -}}
      </div>

      {{- /* Metric tiles grid */ -}}
      <div class="tour-tiles">
        {{- /* Distance tile */ -}}
        {{- if $distanceKm -}}
        <div class="tile tile-distance">
          <div class="tile-icon">ğŸ“</div>
          <div class="tile-value">{{ $distanceKm | htmlEscape }}</div>
          <div class="tile-label">Distanz (km)</div>
        </div>
        {{- end -}}

        {{- /* Elevation tile */ -}}
        {{- if $elevationM -}}
        <div class="tile tile-elevation">
          <div class="tile-icon">â›°ï¸</div>
          <div class="tile-value">{{ $elevationM | htmlEscape }}</div>
          <div class="tile-label">HÃ¶henmeter</div>
        </div>
        {{- end -}}

        {{- /* Max height tile */ -}}
        {{- if $maxHeight -}}
        <div class="tile tile-maxheight">
          <div class="tile-icon">ğŸ”ï¸</div>
          <div class="tile-value">{{ $maxHeight | htmlEscape }}</div>
          <div class="tile-label">Max. HÃ¶he (m)</div>
        </div>
        {{- end -}}

        {{- /* Duration tile */ -}}
        {{- if $durationH -}}
        <div class="tile tile-duration">
          <div class="tile-icon">â±ï¸</div>
          <div class="tile-value">{{ $durationH | htmlEscape }}</div>
          <div class="tile-label">Dauer (h)</div>
        </div>
        {{- end -}}
      </div>

      {{- /* Peaks section (if provided) */ -}}
      {{- if $peaks -}}
      <div class="tour-peaks">
        <div class="peaks-title">Bestiegene Gipfel</div>
        <div class="peaks-list">
          {{- range split $peaks ";" -}}
            {{- $peak := trim . " " -}}
            {{- if $peak -}}
            <div class="peak-item">
              <span class="peak-icon">ğŸ”ï¸</span>
              <span class="peak-name">{{ $peak | htmlEscape }}</span>
            </div>
            {{- end -}}
          {{- end -}}
        </div>
      </div>
      {{- end -}}

      {{- /* Bergfex link */ -}}
      {{- if $bergfexUrl -}}
      <div class="tour-links">
        <a href="{{ $bergfexUrl | htmlEscape }}" target="_blank" rel="noopener noreferrer" class="tour-external-link">
          View on Bergfex â†’
        </a>
      </div>
      {{- end -}}
    </div>

    {{- /* Right column: Map */ -}}
    {{- $mapImage := .Get "map_image" -}}
    {{- if not $mapImage -}}
      {{- /* Check for auto-generated map */ -}}
      {{- $mapImage = printf "/maps/%s.png" $id -}}
    {{- end -}}

    {{- if $mapImage -}}
    <div class="tour-map-section">
      <img src="{{ $mapImage | htmlEscape }}"
           alt="Map of {{ $title | htmlEscape }}"
           class="tour-map-static"
           loading="lazy" />
    </div>
    {{- end -}}
  </div>

  {{- /* GPX download link */ -}}
  {{- if $gpx -}}
  <div class="tour-gpx-download">
    <a href="{{ $gpx | htmlEscape }}" download class="tour-gpx-link">
      ğŸ“¥ Download GPX
    </a>
  </div>
  {{- end -}}
</div>
